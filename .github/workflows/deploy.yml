name: Docker Image CICD

on:
  push:
    branches:
      - master

jobs:
  build:
    environment: prod
    runs-on: self-hosted
    steps:
    - uses: actions/checkout@v2
    - name: Save firestore key
      run: printf '%s' "${{ secrets.FIRESTORE_KEY }}" > nraw-key.json
    - name: Build the Docker image
      run: docker build . --file Dockerfile --tag game_scanner:latest
    - name: Run the Docker image
      run: |
        docker run -d --restart unless-stopped \
        -e GOOGLE_KEY=${{ secrets.GOOGLE_KEY }} \
        -e GOOGLE_CX=${{ secrets.GOOGLE_CX }} \
        -e BGG_USERNAME=${{ secrets.BGG_USERNAME }} \
        -e BGG_PASS=${{ secrets.BGG_PASS }} \
        -e TELEGRAM_TOKEN=${{ secrets.TELEGRAM_TOKEN }} \
        -e OPENAI_BASE_URL=${{ secrets.OPENAI_BASE_URL }} \
        -e OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }} \
        game_scanner:latest python3 telegram_app.py
